
$(document).ready(function(){
	const cardBody = document.querySelector('#cardBody');
    const messageContent = document.querySelector('#message');
    const btnSend = document.querySelector('.btn-send');
    const sockJS = new SockJS("/stomp/chat");
    const stomp = Stomp.over(sockJS);

    stomp.heartbeat.outgoing = 0; //Rabbit���� heartbeat �ȸ����ٰ� ��
    stomp.heartbeat.incoming = 0; //Rabbit���� heartbeat �ȸ����ٰ� ��
	
    function onError(e) {
        console.log("STOMP ERROR", e);
    }

    function onDebug(m) {
        console.log("STOMP DEBUG", m);
    }

    stomp.debug = onDebug;
		
    stomp.connect("[[${session.stompId}]]", "[[${session.stompPwd}]]", function (frame) {
    //stomp.connect("guest", "guest", function (frame) {
        console.log('STOMP Connected');

        /* subscribe ������ ���� rabbit�� Exchange, Queue�� ����� ���� �ٲ� */
        // �ǵڿ� queue �̸� ���̱�.
        stomp.subscribe(`/exchange/chat.exchange/mattmk.routing.key`, function (content) {
			
			console.log('content ---> ', content);
			
			console.log('content.body ---> ', content.body);
			
            const payload = JSON.parse(content.body);
			
			console.log('payload ---> ', payload);
			
            //const html = `<div class="card mb-4 py-3 border-bottom-primary">${payload.message}</div>`;
            var today = new Date();

			var year = today.getFullYear();
			var month = ('0' + (today.getMonth() + 1)).slice(-2);
			var day = ('0' + today.getDate()).slice(-2);
			var hours = ('0' + today.getHours()).slice(-2); 
			var minutes = ('0' + today.getMinutes()).slice(-2);
			var seconds = ('0' + today.getSeconds()).slice(-2); 
			
			
			var showTodayTime = year + '-' + month  + '-' + day + ' ' + hours + ':' + minutes  + ':' + seconds;

              var html = '';
              html += '<div class="col-xl-10 col-md-6 mb-4">';
              html += '<div class="card border-left-primary shadow h-100 py-2">';
              html += '<div class="card-body">';
              html += '<div class="row no-gutters align-items-center">';
              html += '<div class="col mr-2">';
              html += '<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">';
              html += showTodayTime + '</div>';
              html += `<div class="h5 mb-0 font-weight-bold text-gray-800">${payload.message}</div>`;
              html += '</div>';
              html += '<div class="col-auto">';
              html += '<i class="fas fa-comments fa-2x text-gray-300"></i>';
              html += '</div>';
              html += '</div>';
              html += '</div>';
              html += '</div>';
              html += '</div>';
              
            cardBody.insertAdjacentHTML('afterbegin', html);

            //���� ���ڴ� Queue ���� �� �ִ� �ɼ�
            //auto-delete : Consumer�� ������ ������ �����Ǵ� Queue
            //durable : ������ ������ ���ܵ� �޼����� �����ϰ� ����
            //exclusive : ������ �̸��� Queue ���� �� ����
        },{'auto-delete':true, 'durable':false, 'exclusive':false});

    }, onError, '/');

});

function setCookie(name, value, exp) {
		var date = new Date();
		date.setTime(date.getTime() + exp*24*60*60*1000);
		document.cookie = name + '=' + value + ';expires=' + date.toUTCString() + ';path=/';
	};
	
function getCookie (name) {
	var value = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
	return value? value[2] : null;
};